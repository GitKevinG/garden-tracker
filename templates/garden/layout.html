{% extends "base.html" %}
{% block title %}Garden Layout{% endblock %}
{% block mobile_title %}Garden Layout{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h1>Garden Layout</h1>
</div>

<!-- Zone Tabs (desktop) / Select (mobile) -->
<div class="layout-zone-tabs">
    {% for zone in zones %}
    <button class="zone-tab {% if loop.first %}active{% endif %}" data-zone="{{ zone }}" onclick="switchZone('{{ zone }}')">{{ zone }}</button>
    {% endfor %}
</div>
<div class="layout-zone-select">
    <select onchange="switchZone(this.value)">
        {% for zone in zones %}
        <option value="{{ zone }}">{{ zone }}</option>
        {% endfor %}
    </select>
</div>

<div class="layout-container">
    <!-- Sidebar: unplaced items -->
    <div class="layout-sidebar" id="layout-sidebar">
        <h2>Unplaced</h2>
        <div class="layout-sidebar-items" id="sidebar-items">
            {% for item in unplaced %}
            <div class="layout-item layout-item-{{ item.type }} {% if item.is_full %}layout-item-full{% endif %}"
                 draggable="true"
                 data-type="{{ item.type }}" data-id="{{ item.id }}" data-zone="{{ item.zone }}"
                 data-url="{{ item.url }}"
                 id="item-{{ item.type }}-{{ item.id }}">
                <div class="layout-item-name">{{ item.name }}</div>
                <div class="layout-item-info">
                    {% if item.size %}{{ item.size }}gal{% endif %}
                    &middot; {{ item.plants }}/{{ item.capacity }}
                </div>
            </div>
            {% endfor %}
            {% if not unplaced %}
            <div class="empty-state" style="padding: 1rem; font-size: 0.85rem;">All containers placed</div>
            {% endif %}
        </div>
    </div>

    <!-- Grid -->
    <div class="layout-grid-wrapper">
        <div class="layout-grid" id="layout-grid">
            <!-- 8x8 grid cells generated by JS -->
        </div>
    </div>
</div>

<div class="calendar-legend" style="margin-top: 1rem;">
    <div class="legend-item"><span class="dot" style="background: linear-gradient(135deg, #4a7c23, #7cb342);"></span> Grow Bag</div>
    <div class="legend-item"><span class="dot" style="background: linear-gradient(135deg, #5b9bd5, #87ceeb);"></span> Hydro System</div>
    <div class="legend-item"><span class="dot" style="background: #dc2626; border: 2px solid #dc2626;"></span> At Capacity</div>
</div>

<p style="margin-top: 1rem; color: #888; font-size: 0.8rem; text-align: center;">
    Desktop: drag &amp; drop to place. Double-click to remove. &nbsp;|&nbsp; Mobile: tap to select, tap cell to place. Long-press to remove.
</p>

<style>
    .layout-zone-tabs {
        display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;
    }
    .zone-tab {
        padding: 0.5rem 1rem; border: 2px solid var(--leaf); border-radius: 8px;
        background: white; color: var(--leaf-dark); cursor: pointer; font-weight: 600; font-size: 0.85rem;
    }
    .zone-tab.active {
        background: var(--leaf); color: white;
    }
    .layout-zone-select { display: none; margin-bottom: 1rem; }
    .layout-container {
        display: flex; gap: 1.5rem;
    }
    .layout-sidebar {
        width: 200px; flex-shrink: 0; background: white; border-radius: 10px;
        border: 1px solid #ddd; padding: 1rem; max-height: 520px; overflow-y: auto;
    }
    .layout-sidebar h2 { font-size: 1rem; margin-bottom: 0.75rem; }
    .layout-sidebar-items { display: flex; flex-direction: column; gap: 0.5rem; }
    .layout-item {
        padding: 0.5rem 0.65rem; border-radius: 8px; cursor: grab; font-size: 0.8rem;
        border: 2px solid transparent; transition: border-color 0.15s, opacity 0.15s;
        user-select: none;
    }
    .layout-item.selected { border-color: var(--sun) !important; box-shadow: 0 0 6px rgba(244,164,96,0.5); }
    .layout-item-growbag { background: linear-gradient(135deg, #e8f5e9, #c8e6c9); }
    .layout-item-hydro { background: linear-gradient(135deg, #e3f2fd, #bbdefb); }
    .layout-item-full { border-color: #dc2626 !important; }
    .layout-item-name { font-weight: 600; }
    .layout-item-info { font-size: 0.7rem; color: #666; }

    .layout-grid-wrapper { flex: 1; overflow: auto; }
    .layout-grid {
        display: grid; grid-template-columns: repeat(8, 1fr); gap: 3px;
        background: #ccc; border-radius: 10px; overflow: hidden; min-width: 400px;
    }
    .grid-cell {
        background: white; min-height: 65px; padding: 0.35rem; position: relative;
        display: flex; align-items: center; justify-content: center;
        transition: background 0.15s;
    }
    .grid-cell.drag-over { background: #e8f5e9; }
    .grid-cell .layout-item { cursor: pointer; width: 100%; margin: 0; }
    .grid-cell-coords {
        position: absolute; top: 2px; left: 4px; font-size: 0.55rem; color: #bbb;
    }

    @media (max-width: 768px) {
        .layout-zone-tabs { display: none; }
        .layout-zone-select { display: block; }
        .layout-container { flex-direction: column; }
        .layout-sidebar {
            width: 100%; max-height: 140px; overflow-x: auto; overflow-y: hidden;
        }
        .layout-sidebar-items { flex-direction: row; }
        .layout-item { flex-shrink: 0; min-width: 120px; }
        .layout-grid { grid-template-columns: repeat(4, 1fr); min-width: unset; }
        .grid-cell { min-height: 72px; }
    }
</style>

<script>
(function() {
    const ROWS = 8, COLS_DESKTOP = 8, COLS_MOBILE = 4;
    let currentZone = '{{ zones[0] }}';
    let selectedItem = null;
    let allPlaced = {{ placed | tojson }};
    let allUnplaced = {{ unplaced | tojson }};

    function isMobile() { return window.innerWidth <= 768; }
    function getCols() { return isMobile() ? COLS_MOBILE : COLS_DESKTOP; }
    function getRows() { return ROWS; }

    function buildGrid() {
        const grid = document.getElementById('layout-grid');
        const cols = getCols();
        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        grid.innerHTML = '';
        for (let r = 0; r < getRows(); r++) {
            for (let c = 0; c < cols; c++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.row = r;
                cell.dataset.col = c;
                cell.innerHTML = `<span class="grid-cell-coords">${r},${c}</span>`;
                // Desktop drag events
                cell.addEventListener('dragover', e => { e.preventDefault(); cell.classList.add('drag-over'); });
                cell.addEventListener('dragleave', () => cell.classList.remove('drag-over'));
                cell.addEventListener('drop', e => { e.preventDefault(); cell.classList.remove('drag-over'); handleDrop(e, r, c); });
                // Mobile tap to place
                cell.addEventListener('click', () => { if (selectedItem && !cell.querySelector('.layout-item')) placeMobile(r, c); });
                grid.appendChild(cell);
            }
        }
        renderPlaced();
    }

    function renderPlaced() {
        const cols = getCols();
        allPlaced.filter(p => p.zone === currentZone).forEach(item => {
            if (item.col >= cols) return; // off-grid on mobile
            const idx = item.row * cols + item.col;
            const cells = document.querySelectorAll('.grid-cell');
            if (idx >= cells.length) return;
            const cell = cells[idx];
            // don't duplicate
            if (cell.querySelector('.layout-item')) return;
            cell.appendChild(makeItemEl(item, true));
        });
    }

    function makeItemEl(item, placed) {
        const el = document.createElement('div');
        el.className = `layout-item layout-item-${item.type}${item.is_full ? ' layout-item-full' : ''}`;
        el.draggable = true;
        el.dataset.type = item.type;
        el.dataset.id = item.id;
        el.dataset.zone = item.zone;
        el.dataset.url = item.url;
        el.id = `item-${item.type}-${item.id}`;
        el.innerHTML = `<div class="layout-item-name">${item.name}</div><div class="layout-item-info">${item.size ? item.size + 'gal' : ''} &middot; ${item.plants}/${item.capacity}</div>`;

        // Drag start
        el.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', JSON.stringify({type: item.type, id: item.id}));
        });

        if (placed) {
            // Desktop: single click navigates, double-click removes
            // Use a timer so dblclick can cancel the navigation
            let clickTimer = null;
            el.addEventListener('click', e => {
                e.stopPropagation();
                if (isMobile()) return; // mobile uses touchend for nav
                if (clickTimer) { clearTimeout(clickTimer); clickTimer = null; return; }
                clickTimer = setTimeout(() => { clickTimer = null; window.location = item.url; }, 300);
            });
            el.addEventListener('dblclick', e => {
                e.stopPropagation();
                e.preventDefault();
                if (clickTimer) { clearTimeout(clickTimer); clickTimer = null; }
                if (confirm(`Remove "${item.name}" from grid?`)) removeFromGrid(item);
            });
            // Mobile: tap navigates
            el.addEventListener('touchend', e => {
                // Only navigate if not a long-press (handled separately)
                if (!e.defaultPrevented) window.location = item.url;
            });
            // Mobile long-press -> remove
            let pressTimer;
            el.addEventListener('touchstart', e => {
                pressTimer = setTimeout(() => {
                    e.preventDefault();
                    if (confirm(`Remove ${item.name} from grid?`)) removeFromGrid(item);
                }, 600);
            });
            el.addEventListener('touchend', () => clearTimeout(pressTimer));
            el.addEventListener('touchmove', () => clearTimeout(pressTimer));
        } else {
            // Sidebar: mobile tap to select
            el.addEventListener('click', e => {
                e.stopPropagation();
                if (isMobile()) {
                    document.querySelectorAll('.layout-item.selected').forEach(s => s.classList.remove('selected'));
                    el.classList.add('selected');
                    selectedItem = item;
                } else {
                    window.location = item.url;
                }
            });
        }
        return el;
    }

    function handleDrop(event, row, col) {
        const data = event.dataTransfer ? event.dataTransfer.getData('text/plain') : null;
        if (!data) return;
        const {type, id} = JSON.parse(data);
        savePosition(type, id, row, col);
    }

    function placeMobile(row, col) {
        if (!selectedItem) return;
        savePosition(selectedItem.type, selectedItem.id, row, col);
        document.querySelectorAll('.layout-item.selected').forEach(s => s.classList.remove('selected'));
        selectedItem = null;
    }

    function savePosition(type, id, row, col) {
        fetch('{{ url_for("garden_layout_update") }}', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({type, id, row, col})
        }).then(r => r.json()).then(d => {
            if (d.ok) {
                // Move item from unplaced to placed
                let idx = allUnplaced.findIndex(i => i.type === type && i.id === id);
                let item;
                if (idx >= 0) {
                    item = allUnplaced.splice(idx, 1)[0];
                } else {
                    idx = allPlaced.findIndex(i => i.type === type && i.id === id);
                    if (idx >= 0) item = allPlaced.splice(idx, 1)[0];
                }
                if (item) { item.row = row; item.col = col; allPlaced.push(item); }
                rebuildAll();
            }
        });
    }

    function removeFromGrid(item) {
        fetch('{{ url_for("garden_layout_remove") }}', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({type: item.type, id: item.id})
        }).then(r => r.json()).then(d => {
            if (d.ok) {
                const idx = allPlaced.findIndex(i => i.type === item.type && i.id === item.id);
                if (idx >= 0) {
                    const removed = allPlaced.splice(idx, 1)[0];
                    removed.row = null; removed.col = null;
                    allUnplaced.push(removed);
                }
                rebuildAll();
            }
        });
    }

    function rebuildSidebar() {
        const container = document.getElementById('sidebar-items');
        container.innerHTML = '';
        const items = allUnplaced.filter(i => i.zone === currentZone);
        if (!items.length) {
            container.innerHTML = '<div class="empty-state" style="padding: 1rem; font-size: 0.85rem;">All containers placed</div>';
            return;
        }
        items.forEach(item => container.appendChild(makeItemEl(item, false)));
    }

    function rebuildAll() {
        buildGrid();
        rebuildSidebar();
    }

    window.switchZone = function(zone) {
        currentZone = zone;
        document.querySelectorAll('.zone-tab').forEach(t => t.classList.toggle('active', t.dataset.zone === zone));
        rebuildAll();
    };

    window.addEventListener('resize', () => rebuildAll());
    rebuildAll();
})();
</script>
{% endblock %}
